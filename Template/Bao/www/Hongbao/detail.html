<include file="Public:header" />
<div class="container">
    <div class="bg" style="background: #fffbf3">
    <input type="hidden" name="id" value="{$hongbao['from_number_no']}" />
	<div class="detail_header">
		<div class="detail_head_block"><img src="{$hongbao_user.header}" alt="{$hongbao_user.name}" class="detail_head_img" /></div>
	</div>
	<div class="cl"></div>
	<div class="from mt40 cl">
		<ul>
			<div class="tit mt20">
				<div class="title">{$hongbao_user.name}发的红包</div>
				<div class="remark" style="margin: 16px 0; font-size: 18px">{$hongbao.remark}</div>

                <ul >
                    <div class="tit mt20">
                        <if condition="$receive_order">
                            <div class="title"><font>您已领取：</font>￥{$receive_order.amount}元</div>
                        </if>
                    </div>
                </ul>
			</div>
		</ul>
		<div class='detail_block ' data-role="detail_default">
			<ul>
				<div class="tit">
                    <if condition=" count($order_list) eq $hongbao_total_num">
                        <div class="title" style="font-size: 16px; margin: 8px 0;"><img src="/images/ok.png" style=" width:16px; vertical-align: middle" /> 领完啦~</div>
                        <div class="title" style="font-size: 12px; margin: 8px 0; color: #bbb">{$hongbao_total_num}个红包已领完，用时{$use_time}</div>
                    </if>
                    <div class="">
                        <if condition="$hongbao['user_id'] eq $user_id">
                            <button type="button"  onclick="set_share()" style="font-size: 24px; color: #fdf05e" class="btn btn_cou"><font>分享</font></button>
                        <elseif condition="$hongbao['is_sponsor'] eq 1" />
                            <button type="button" style="font-size: 24px; color: #fdf05e" class="btn btn_cou" data-role="zanzhu"><font>赞助</font></button>
                        </if>
                    </div>
                    <if condition="$hongbao['user_id'] eq $user_id">
					<div class="set_sponsor">
						    <a href="javascript:void(0)" class="set_sponsor_block" style="margin-top: 10px!important; clear: both; line-height: 36px;" data-state="<if condition="$hongbao['is_sponsor'] eq 1">0<else/>1</if>" onclick="set_sponsor(this)">设为“<if condition="$hongbao['is_sponsor'] eq 1">不<else/></if>可赞助”</a>

					</div>
                        </if>
				</div>
			</ul>
		</div>

	</div>
    <if condition="$from_bao_list">
    <div class="order_list" style="background: #fffbf3">
        <div class="header bt_line">
            <img src="/images/xing.png" style="width: 16px; vertical-align: middle" /> <span  style="color: #ff9802!important; font-size: 14px">{$hongbao_user['name']}的土豪朋友</span>
        </div>
        <div class="block" style="min-height: 100px;">
            <table cellpadding="0" cellspacing="0" border="0">
                <volist name="from_bao_list" id="order" key="i">
                <tr  <if condition="$i gt 5">data-role="order" style="display:none"</if>>
                    <td width="70" style="text-align: left"><div class=" fl ml10"><img src="{$order.user.header}" alt="{$order.user.name}" class="detail_head_img2" /></div></td>
                    <td style="text-align: left"><div class="fl ml10">
                        <div class="cl tl" style="margin-top: 6px; width: 100%;"><span style="color: #ff9802!important; font-size: 14px">{$zhaopian_user.name}</span> <span class="fr" >赞助{$order.total_num}个红包,共{$order.total_amount}元</span> </div>
                        <div class="cl tl remark" style=" font-size: 14px; width: 100%">“{$order.remark}”</div>
                    </div></td>
                </tr>
                </volist>
            </table>

            <div class="cl"></div>

        </div>
        <if condition="count($from_bao_list) gt 5">
            <div class="xiala">
                <div class="view_all"><span><img src="/images/xia.png" class="img" style="width:12px;"/></span> <span class="f12">查看全部赞助者</span></div>
            </div>
        </if>


    </div>
    </if> <div class="cl"></div>
        <div class="xiala" style="margin: 0 auto; text-align: center">
            <div class="s"><span style="color: #ff9802!important; font-size: 14px; padding-bottom: 12px">赞助TA的红包，做TA的土豪朋友</span></div>
        </div>
        <div class="cl" style="height: 14px"></div>
    </div>

	<div class="order_list">
		<div class="header bt_line">
			<span><img src="/images/sm.png" style="width:14px; line-height:14px; vertical-align:middle;" /></span> <span>已有{:count($order_list)}人领取红包，共计￥{$total_order_amount}元</span>
		</div>
		<div class="block" style="min-height: 200px;">
            <volist name="order_list" id="order" key="i">
			<ul class="bt_line p6" <if condition="$i gt 5">data-role="order" style="display:none"</if>>
				<div class="head_img fl" style="width:70px;"><img src="{$order.user.header}" alt="{$order.user.name}" class="detail_head_img2" /></div>
					<div class="detail fl">
						<li class="cl tl">{$order.user.name} <if condition="$order.id eq $star_order and $is_show_star"><img src="/images/xing.png" style="width: 14px;" /> <span  style="color: #ff9802!important">手气最佳</span></if></li>
						<li class="cl tl" style="color: #999">{$order.addtime|date="Y-m-d H:i:s",###}</li>
					</div>

					<div class="detail fr">
						<li class="cl tr">￥{$order.amount}</li>
						<li class="cl tr" style="color: #ff9802!important" >已领取</li>
					</div>

				<div class="cl"></div>
			</ul>
                </volist>

			<div class="cl"></div>
		</div>
        <if condition="count($order_list) gt 5">
		<div class="xiala">
			<div class="view_all"><span><img src="/images/xia.png" class="img" style="width:12px;"/></span> <span class="f12">查看全部参与者</span></div>
		</div>
            </if>
		<div class="xiala">
			<div><a href="{:U('/bao/hongbao')}"><input type="button" class="btn w120" value="我发红包" /></a> <a href="{:U('/bao/notes')}" style="margin-left: 20px"><input type="button" class="btn w120" value="我的记录" /></a></div>
			<div class="cl h12"></div>
		</div>
		<div class="cl"></div>
	</div><div class="cl"></div>
	<div class="from "><div class="foot_reamrk">如果72小时内该红包没有领完, 系统会自动退还余额</div></div>
     <div class="cl" ></div>

    <div id="shareit1" style="display:  <if condition="$is_show_share and $user_id eq $hongbao['user_id']">block<else />none</if>">
        <div class="shareit"></div>
        <span style="" class="follow"> <img src="/images/share-it.png" style="height:120px;" class="arrow">
            <img src="/images/xinhongbao_bg.png" class="bg" style="left: 0; top: 0;" />
        </span>
    </div>

<div id="error_block" style="display: none">
    <div id="shareit"></div>
    <span style="" class="follow">
        <div style="padding-right: 0px; padding-left: 0px; margin-top: 16px; font-size: 20px; color: #fff" class="text"><p>被人抢先一步了...</p></div>
		<div>
            <img src="/images/ico_ku.png" style="width:80px;" />
        </div>
		<div style="padding: 0px; margin-top: 8px; font-size: 12px; color: #fff" class="text">红包已经被人抢光了~ </div>
    </span>
</div>

    <div id="remark_block" class="box_block" style='<if condition="!$receive_order and $hongbao_total_num gt count($order_list) and $user_id neq $hongbao['user_id']">display: block<else/>display:none</if>'>
        <div class="shareit"></div>
        <div class="follow">
            <p style="text-align: center; padding: 12px; font-size: 18px; line-height: 24px;">
                <img src="{$hongbao_user.header}" alt="{$hongbao_user.name}" class="detail_head_img" /> <br />
                <span>{$hongbao_user.name}</span><br/>
                <span style="font-size: 16px; padding-top: 12px; clear: both;">发了一个红包, 金额随机</span><br/>
                <span style="font-size: 20px; padding-top: 28px; clear: both;">“{$hongbao.remark}”</span></p>
            <img src="/images/linghongbao-banner.png" onclick="set_order()" style="width: 100%;" />
            <div class="cls" style="clear: both; margin-bottom: 6px;"></div>
            <p style="text-align: center; padding: 12px; font-size: 16px; line-height: 20px;" onclick="$('#remark_block').hide();">看看大家手气></p>
        </div>
    </div>

<div  class="bao_block " style='display: none'> <div class="shareit"></div>
<div class="follow" style="background: #fff5e4!important; width: 90%;">
    <div class="from" style="width: 86%;">
        <div class="close_block" onclick="$('.bao_block').hide();" style="float: right; clear: both; margin-bottom: 12px;"><img src="/images/icon-close-round.png" style="height: 18px" /></div>
        <form action="{:U('/bao/hongbao/add')}" method="post" name="theForm" id="theForm" onSubmit="return checkHongBao(this)">
            <input type="hidden" name="sign" value="{$sign}" />
            <input type="hidden" name="bao_id" value="" />
            <ul>
                <div class="row" style="background: #ffe9c4">
                    <span class="label" style="color: #ba8120">红包个数</span><input class="fr" name="total" type="number" id="total" style="margin-right: 34px;background: #ffe9c4; color: #494949" oninput="checkTextLength( this,3)" maxlength="3" value="" placeholder="填写个数" /> <span class="unit" style="color: #ba8120">个</span>
                </div>
            </ul>
            <ul>
                <div class="row" style="background: #ffe9c4">
                    <span class="label" style="color: #ba8120">总金额 <img src="/images/icon-pin.png" style="width: 14px; vertical-align: middle; " /></span><input class="fr"  name="amount" type="number" id="amount" style="margin-right: 34px;background: #ffe9c4;color: #494949" placeholder="填写金额" oninput="checkTextLength( this,4)" maxlength="4" value="" /> <span class="unit"  style="color: #ba8120">元</span>
                </div>
            </ul>
            <ul>
                <div class="row" style="height: 80px;background: #ffe9c4">
                    <textarea class="fr color_999 tl"  name="remark" maxlength="120" style="margin-right: 34px; height: 80px; width: 88%;color: #494949;background: #ffe9c4; line-height:20px; " id="remark">恭喜发财,大吉大利!</textarea>
                </div>
            </ul>
            <ul>
                <div class="tit">
                    <div class="amount" style="color: #bf8b37; margin-top: 20px;">￥<font class="total_amount">0</font></div>
                </div>
            </ul>
            <ul>
                <div class="tit">
                    <div class="w90 mc">
                        <input type="button" class="btn zanzhubao" value="塞钱进红包" />
                    </div>
                    <div class="w90 mc tc" style="color: #bbb; padding: 12px 0; font-size: 13px">
                        72小时红包没领完，钱会退回您微信零钱
                    </div>
                </div>
            </ul>
        </form>
    </div>
</div>
</div>
</div>

<script type="text/javascript">
    var w = $('#follow').width();
    $('#follow img.bg').css('width', w+'px');
</script>

<include file="Public:foot" />

<script type="text/javascript">
    //调用微信JS api 支付
    function jsApiCall(data)
    {
        WeixinJSBridge.invoke(
                'getBrandWCPayRequest',
                data,
                function(res){
                    //WeixinJSBridge.log(res.err_msg);
                    // alert(res.err_code+'='+res.err_desc+'='+res.err_msg);
                    // window.location.href = "/notes.html";
                    // alert('支付成功');
//                    window.location.href="?show_share=1";
//                    return false;
//                    window.location.reload();
//                    return false;
                    switch (res.err_msg){

                        case 'get_brand_wcpay_request:cancel':
                            // location.href="/?_a=fail&order_sn=<?php echo $order_sn;?>";
//                                alert('取消');
                            break;
                        case 'get_brand_wcpay_request:fail':
                            //location.href="/?_a=fail&order_sn=<?php echo $order_sn;?>";
//                            alert('错误');
//                            alert(res);
                            layer.msg('支付失败请重试', function(){});
                            break;
                        case 'get_brand_wcpay_request:ok':
                            var number_no = $('input[name="id"]').val();
                            location.href="/index.php?s=/bao/hongbao/detail/id/"+number_no+".html";
                            break;
                    }
                }
        );
    }

    function callpay(data)
    {
        if (typeof WeixinJSBridge == "undefined"){
            if( document.addEventListener ){
                document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
            }else if (document.attachEvent){
                document.attachEvent('WeixinJSBridgeReady', jsApiCall);
                document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
            }
        }else{
            jsApiCall(data);
        }
    }
</script>


<script type="text/javascript">
    $('.view_all').click(function(){
        $('[data-role="order"]').toggle();
        if($('.view_all .f12').text() == '查看全部参与者'){
            $('.view_all .f12').text('收起全部参与者');
            $('.view_all .img').attr('src', '/images/shang.png');
        }else{
            $('.view_all .f12').text('查看全部参与者');
            $('.view_all .img').attr('src', '/images/xia.png');
        }
    });
</script>

<script type="text/javascript">
    $('[data-role="zanzhu"]').click(function(){
        $('.bao_block').show();
    });
    $('input[name="amount"]').keyup(function(){
        var amount = parseFloat($(this).val() == ''?0:$(this).val());
        $('.total_amount').text(amount);

    });

    $('input[name="amount"]').change(function(){
        var amount = parseFloat($(this).val() == ''?0:$(this).val());
        $('.total_amount').text(amount);

    });
    $('.zanzhubao').click(function(){
        if(checkBao()){
            var amount = $('input[name="amount"]').val();
            var total = $('input[name="total"]').val();
            var remark = $('textarea[name="remark"]').val();
            var id = $('input[name="id"]').val();
            var bao_id = $('input[name="bao_id"]').val();
            var index = layer.load(1, {
                shade: [0.1,'#000'] //0.1透明度的白色背景
            });

            $.ajax({
                type: "POST",
                url: "{:U('/bao/hongbao/add')}",
                data: { amount: amount, total:total, remark:remark, from_id:id, id:bao_id} ,
                dataType:'json',
                success: function(data){
                    layer.close(index);
                    if(data.msg_code == 10001){
                        $('input[name="bao_id"]').val(data.number_no);
                        jsApiCall(data.jsApiParameters);
                    }else{
                        layer.msg(data.msg_content, function(){});
                    }
                }
            });
        }
    });

    //立即分享到微信朋友圈点击事件
    $("#error_block").on("click", function() {
        $("#error_block").hide();
    });

    function set_share(){
        $("#shareit1").show();
    }

    $("#shareit1").on("click", function(){
        $("#shareit1").hide();
    })

    /**
     * 设置赞赏
     */
    function set_sponsor(_this){
        var id = $('input[name="id"]').val();
        var state = parseInt($(_this).attr('data-state'));
        var index = layer.load(1, {
            shade: [0.1,'#000'] //0.1透明度的白色背景
        });

        $.ajax({
            type:'post',
            url:"{:U('/bao/hongbao/sponsor')}",
            async:false,
            cache:false,
            data:{id:id,state:state},
            dataType:'json',
            success:function(result){
                layer.close(index);
                if(result.msg_code==10001){
                    // callpay(result.data);
                    //$('.set_sponsor').remove();
                    $(_this).attr('data-state', state==1?0:1);
                    // 设为“<if condition="$hongbao['is_sponsor'] eq 1">不<else/></if>可赞助”
                    $(_this).text("设为“"+(state==1?'不':'')+"可赞助“");
                    layer.msg('设置成功');
                }else{
                    layer.msg(result.message, function(){});
                    return false;
                }
            }
        });
    }

    /**
     * 生成红包订单
     */
    function set_order(){
        var id = $('input[name="id"]').val();
        // alert("{:U('/bao/hongbao/order')}");
        var index = layer.load(1, {
            shade: [0.1,'#000'] //0.1透明度的白色背景
        });
        $.ajax({
            type:'post',
            url:"{:U('/bao/hongbao/order')}",
            async:false,
            cache:false,
            data:{id:id},
            dataType:'json',
            success:function(result){
                layer.close(index);
                if(result.msg_code==10001){
                    // layer.msg('', function(){});
                    // 重载
                    window.location.reload();
                }else{
                    layer.msg(result.msg_content, function(){});
                    return false;
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                alert(XMLHttpRequest.status);
                alert(XMLHttpRequest.readyState);
                alert(textStatus);
            }
        });

    }

    function checkBao(){
        var amount = $('input[name="amount"]').val();
        var reg = new RegExp("^[0-9]*\.?[0-9]*$");
        if(!reg.test(amount)){
            layer.msg('请填写正确金额.', function(){});
            return false;
        }

        var total = $('input[name="total"]').val();
        if(!reg.test(total)){
            layer.msg('请填写整数份额.', function(){});
            return false;
        }

        if(amount / total > 200 || amount / total < 1.05){
            layer.msg('平均每个红包在1.05-200元之间.', function(){});
            total_amount = (total * 1.05).toFixed(2);
            $('input[name="amount"]').val(total_amount);
            $('.total_amount').html(total_amount);
            return false;
        }

        var remark = $.trim($('textarea[name="remark"]').val());
        if(remark.length < 2){
            layer.msg('请输入红包说明.', function(){});
            return false;
        }
        return true;
    }

    function checkHongBao(_this){
        return true;
    }

</script>
</body>
</html>
