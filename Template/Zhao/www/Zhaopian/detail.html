<include file="Public:header" />

<div class="container">

    <input type="hidden" name="id" value="{$zhaopian.id}" />
    <input type="hidden" name="number_no" value="{$zhaopian.number_no}" />
    <input type="hidden" name="min_amount" value="{$zhaopian.min_amount}" />
    <input type="hidden" name="max_amount" value="{$zhaopian.max_amount}" />
    <input type="hidden" name="is_rand" value="{$zhaopian.is_rand}" />
    <if condition="!$is_buy">
    <div class="buy_block" >
        <div class="detail_bg_block">&nbsp;</div>
        <div class="detail_bg">
            <canvas height="100%" width="100%" style="width: 100%; height: 100%" id="canvas"></canvas>
            <img class="preview" id="preview" src="{$base_url}/uploads/{$zhaopian.pic_url}" alt="{$zhaopian.remark}" style="display: none" />
        </div>
        <div class="detail_info">
            <div class="mt40 cl" style="margin-top: 4px;"><img src="{$zhaopian_user.header}" class="detail_head_img" /></div>
            <div class="cl">{$zhaopian_user.name}</div>
            <div class="cl remark">“{$zhaopian.remark}”</div>
        </div>
        <div class="detail_body">
            <div class=" mc tc cl" style="width: 80px;"><button class="btn btn_cou btn_shang" style="border: none;" data-id="{$zhaopian.number_no}">赏</button> </div>
            <div class="remark cl">已有{$total_num}人赏红包</div>

        </div>

        <div class="buy_detail_block hide">
            <div id="remark_block">
                <div id="shareit">
                </div>
    <span style="text-align: center; background: #fff; position: fixed; padding: 12px; -webkit-border-radius:5px;border-radius:5px; line-height: 18px; border: 1px solid #000; width: 90%; left: 5%;" id="follow">
      <div class="fr" style="cursor: pointer" onclick="$('.buy_detail_block').removeClass('show').addClass('hide')">X</div>
        <p style="color: #999">
            <input type="hidden" name="amount" value="1.05" />
            <span style="color: #E08100; font-size: 28px; padding: 4px 0" class="amount_block">1.05元</span> <br />
           发红包看照片,金额随机</p>

        <input type="button" class="btn btn_cou mc" onclick="set_order();" data-role="set_pay_block" style="border: none; width: 80%; height: 36px; margin-top: 12px; margin-bottom: 12px; line-height: 36px;" value="赏" />
       </span>
            </div>
        </div>
    </div>
    </if>
    <if condition="$is_buy">
        <div class="own_block">
            <div class="detail_info1">
                <div class=" fl ml10"><img src="{$zhaopian_user.header}" class="detail_head_img" /></div>
                <div class="fl ml10">
                    <div class="cl tl"><span style="color: #e5e5e5; font-size: 14px;">{$zhaopian_user.name}</span> <span style="background: #2d2d2d; padding: 6px; color: #c62a6c">已打赏{$zhaopian_order['amount']}元</span></div>
                    <div class="cl tl remark" style="color: #e5e5e5; font-size: 16px;">“{$zhaopian.remark}”</div>
                </div>
                <div class="cl"></div>
            </div>
            <div class="cl"></div>
            <div class="detail_body1 cl" >
                <img src="/uploads/{$zhaopian['pic_url']}" style="width: 100%; height: 100%" />
            </div>
        </div>
    </if>

    <div class="detail_body" style="bottom: 20px;">
        <div class="detail_menu_body cl hide">
            <div class="item_menu">
                <div class="sub_menu"><a href="{:U('/zhao/notes')}">我的记录</a></div>
                <div class="sub_menu"><a href="{:U('/zhao/zhaopian')}">我也要发</a></div>
            </div>
        </div>
        <div class="detail_menu cl" data-role="detail_menu">
            <div class="menu_detail"><img class="ico" src="/images/xia_ico.png" /></div>
        </div>
    </div>
</div>

<include file="Public:foot" />

<script type="text/javascript">

    $('.preview').css('width',$(window).width() );
    $('.preview').css('height',$(window).height() );
    $('canvas').css('height',$(window).height() );
    $('canvas').css('width',$(window).width() );

    $(window).resize(function(){
        $('.preview').css('width',$(window).width() );
        $('.preview').css('height',$(window).height() );
        $('canvas').css('height',$(window).height() );
        $('canvas').css('width',$(window).width() );
    });

    stackBlurImage( 'preview', 'canvas', 10, false );

    $('[data-role="detail_menu"]').click(function(){
       var src = $(this).find('img.ico').attr('src');
        if(src.indexOf('xia_ico.png') >= 0 ){
            $('.detail_menu_body').removeClass('hide').addClass('show');
            $(this).find('img.ico').attr('src','/images/shang_ico.png');
        }else{
            $('.detail_menu_body').removeClass('show').addClass('hide');
            $(this).find('img.ico').attr('src','/images/xia_ico.png');
        }
    });
    //调用微信JS api 支付
    function jsApiCall(data)
    {
        WeixinJSBridge.invoke(
                'getBrandWCPayRequest',
                data,
                function(res){
                    //WeixinJSBridge.log(res.err_msg);
                    // alert(res.err_code+'='+res.err_desc+'='+res.err_msg);
                    // window.location.href = "/notes.html";
                    // alert('支付成功');
//                    window.location.href="?show_share=1";
//                    return false;
                    window.location.reload();
                    return false;
                    switch (res.err_msg){

                        case 'get_brand_wcpay_request:cancel':
                            // location.href="/?_a=fail&order_sn=<?php echo $order_sn;?>";
//                                alert('取消');
                            break;
                        case 'get_brand_wcpay_request:fail':
                            //location.href="/?_a=fail&order_sn=<?php echo $order_sn;?>";
//                            alert('错误');
                            break;
                        case 'get_brand_wcpay_request:ok':
                            // location.href="/?_a=done&order_sn=<?php echo $order_sn;?>&ac=<?php echo $authcode?>";
                            //alert('成功');
                            $("#shareit1").show();
                            break;
                    }
                }
        );
    }

    function callpay(data)
    {
        if (typeof WeixinJSBridge == "undefined"){
            if( document.addEventListener ){
                document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
            }else if (document.attachEvent){
                document.attachEvent('WeixinJSBridgeReady', jsApiCall);
                document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
            }
        }else{
            jsApiCall(data);
        }
    }
</script>

<script type="text/javascript">
    $('.btn_shang').click(function(){
        var max = parseFloat($('input[name="max_amount"]').val());
        var min = parseFloat($('input[name="min_amount"]').val());
        var is_rand = $('input[name="is_rand"]').val();
        var amount = (Math.random()*(max-min)+min).toFixed(2);

        if(is_rand == '1'){
            $('.amount_block').text(amount+'元');
            $('input[name="amount"]').val(amount);
        }else{
            $('.amount_block').text(min+'元');
            $('input[name="amount"]').val(min);
        }
        // 设置随机金额
        //
        $('.buy_detail_block').removeClass('hide').addClass('show');
    });
    /**
     * 生成支付订单
     */
    function set_order(){
        var id = $('input[name="number_no"]').val();
        var amount = $('input[name="amount"]').val();
        $.ajax({
            type:'post',
            url:"{:U('/zhao/zhaopian/order')}",
            async:false,
            cache:false,
            data:{id:id, amount:amount},
            dataType:'json',
            success:function(result){
                if(result.error==0){
                    // callpay(result.data);
                    set_pay(result.data);
                }else if(result.error==1){
                    layer.msg(result.message, function(){});
                    return false;
                }
            }
        });

    }

    function set_pay(id){
        if(!id){
            var id = $('input[name="pay_id"]').val();
        }

        if(id.length < 1){
            layer.msg('没有支付订单', function(){});
            return false;
        }
        $.ajax({
            type:'post',
            url:"{:U('/zhao/weixin/zhaopian')}",
            async:false,
            cache:false,
            data:{id:id},
            dataType:'json',
            success:function(result){

               // alert(result.error);

                if(result.error==0){

                    callpay(result.data);

                }else if(result.error==1){
                    layer.msg(result.message, function(){});
                }
            }
        });
    }

    function checkHongBao(_this){
        return true;
    }

</script>
</body>
</html>
