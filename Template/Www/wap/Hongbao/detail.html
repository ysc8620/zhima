<include file="Public:header"/>
<script type="text/javascript">
    //调用微信JS api 支付
    function jsApiCall(data)
    {
        WeixinJSBridge.invoke(
                'getBrandWCPayRequest',
                data,
                function(res){
                    //WeixinJSBridge.log(res.err_msg);
                    // alert(res.err_code+'='+res.err_desc+'='+res.err_msg);
                    // window.location.href = "/notes.html";
                   // alert('支付成功');
                    $("#shareit1").show();
                    return false;
//                    window.location.reload();
//                    return false;
                    switch (res.err_msg){

                        case 'get_brand_wcpay_request:cancel':
                            // location.href="/?_a=fail&order_sn=<?php echo $order_sn;?>";
//                                alert('取消');
                            break;
                        case 'get_brand_wcpay_request:fail':
                            //location.href="/?_a=fail&order_sn=<?php echo $order_sn;?>";
//                            alert('错误');
                            break;
                        case 'get_brand_wcpay_request:ok':
                            // location.href="/?_a=done&order_sn=<?php echo $order_sn;?>&ac=<?php echo $authcode?>";
                            //alert('成功');
                            $("#shareit1").show();
                            break;
                    }
                }
        );
    }

    function callpay(data)
    {
        if (typeof WeixinJSBridge == "undefined"){
            if( document.addEventListener ){
                document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
            }else if (document.attachEvent){
                document.attachEvent('WeixinJSBridgeReady', jsApiCall);
                document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
            }
        }else{
            jsApiCall(data);
        }
    }
</script>
<div class="container">
    <div class="mod_container">
        <div id="detailCon" class="wx_wrap">
            <div class="">
                <div class="my_head hongbao_bg">
                        <div class="my_head_pic">
                            <img width="130" height="130" src="{$hongbao_user.header}" class="my_head_img">
                        </div>
                        <div class="my_head_info">
                            <h4 class="my_head_name ">{$hongbao_user.name}</h4>
                        </div>
                    <div class="clear"></div>
                </div>
                <div class="hongbao_info">
                    <span class="hongbao_user">{$hongbao_user.name}发起了一个凑红包</span><br />
                    <span class="hongbao_remark">{$hongbao.remark}</span>
                </div>

                <php>if ($hongbao[state] == 2):</php>
                <div class="hongbao_info">
                    <i style="font-size:28px; vertical-align: middle; color: green" class="fa fa-check-circle"></i> <font style="font-size: 18px; font-weight: bold; color: #555">凑齐啦！</font>
               <br />
                    <p style="font-size: 38px; padding: 14px 0; line-height: 48px; font-weight: bold">￥{$hongbao.total_amount}</p>
                        <span>每份{$hongbao.part_amount}元，共{$hongbao.total_part}份</span><br />
                    <span>{$total_user}人参加，{$use_time}凑齐</span><br />
                    <php>if($hongbao[user_id] == $user[uin]):</php>
                    <p style="padding: 12px 20px; text-align: left">
                        红包将会在1~3个工作日内，通过微信红包打给你，
                        其中已扣除2%的微信支付手续费，扣除后金额为{$hongbao_amount}元。<br /><br />

                        因为微信支付到我们的账户需要1~3个工作日，我们的账户预存垫付的现金不足，暂时不能实时转账，希望理解，资金安全请你放心，如果您有疑问请联系客服。
                    </p>
                    <php>endif;</php>
                </div>
               <php>else:</php>
                <div class="hongbao_info">
                    <span class="hongbao_user">目标金额￥{$hongbao.total_amount}元</span>
                </div>

                <div class="hongbao_jindu">
                    <div class="hongbao_jindu_bg">
                        <div class="hongbao_jindu_f" style="color:#fff; text-align:center; width: {$percentage}%">
                            {$percentage}%
                        </div>
                    </div>
                </div>

                <div class="hongbao_info">
                    <span class="hongbao_remark">每份{$hongbao.part_amount}元，共{$hongbao.total_part}份，还差{$difference}份凑成。</span><br />
                </div>
                <div class="address_new detail_block" data-role="detail_default">
                    <p class="action" style="text-align: center">
                        <if condition="$hongbao.state eq 1 and $hongbao[addtime]+86400 gt time()">
                            <if condition="$hongbao['total_part']-$hongbao['total_num']-$wait_total lt 1">
                                <span style="clear: both; margin: 8px 0; line-height: 22px;">最后{$wait_total}份正在支付<br/></span>
                                <img src="/images/cou_f.png" style="width: 80px; clear: both;"  />
                                <else />
                                <img src="/images/cou.png" style="width: 80px;" onclick="set_buy()" />
                            </if>
                        <else />
                            <button class="submit" disabled style="width: 100px; margin: 0 auto; text-align: center"><if condition="$hongbao.state eq 2">已完成<elseif condition="$hongbao.state eq 3 or $hongbao.state eq 1" />已过期<elseif condition="$hongbao.state eq 4" />已退款</if></button>
                        </if>

                    </p>
                </div>

                <!--//start-->
                <div data-role="detail_buy" class="hidden detail_block" style="display: none;">

                    <input type="hidden" name="id" value="{$hongbao.number_no}" />
                    <input type="hidden" name="sign" value="{$sign}" />
                    <input type="hidden" name="part_amount" value="{$hongbao.part_amount}" />
                    <input type="hidden" name="max_total" value="{$hongbao['total_part']-$hongbao['total_num']}" />
                    <!--//start -->
                    <div class="order ">
                        <div class="wx_wrap">
                            <div class="address_new">
                                <div class="hongbao_info">
                                    <span class="hongbao_remark">您需要支付：￥<span class="part_amount">{$hongbao.part_amount}</span>元</span><br />
                                </div>
                                <div style="text-align: center">
                                    <label for="num"><span class="tit"></span>
                                        <input type="button" class="jian" value="-" style="width: 30px; margin-right: 2px;"><input name="num" type="number" class="inputBg" readonly id="num" style="width: 100px; margin: 0 auto; text-align: center" value="1" placeholder="总份数"/><input class="jia" style="width: 30px; margin-left: 2px;" type="button" value="+"> <span class="" style="line-height: 36px; font-size:16px;">份</span>
                                        <span id="updateTip2" style="color: red; display: none;"></span> </label>
                                </div>

                                <p class="action">
                                    <if condition="$hongbao.state eq 1">
                                        <if condition="$hongbao[addtime]+86400 gt time()">
                                            <button type="button" onclick="set_order()" class="submit cou_num" style="width: 100px; margin: 0 auto;" id="add">凑 1 份</button>
                                            <else/>
                                            <button class="submit" disabled id="add">已 过 期</button>
                                        </if>
                                        <else/>
                                        <button class="submit" id="add" disabled><if condition="$hongbao.state eq 2">已完成<elseif condition="$hongbao.state eq 3" />已过期<elseif condition="$hongbao.state eq 4" />已退款<else />已关闭</if></button>
                                    </if>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <!--//end-->
                <div class="state_btn"> <a class='state_btn_4' href="javascript:void(0)" onclick="show_remark()">凑红包玩法?</a> </div>
                <php>endif;</php>
                <div class="ptit"><i style="font-size:14px;" class="fa fa-info-circle"></i> <if condition="$hongbao.state eq 2">幸运星已经产生，快找发起人要福利吧！<else />凑齐后,会根据参与金额,随机产生一名幸运星</if></div>
                <!--//start -->
                <volist name="order_list" id="order" key="i">
                <div class="order " <if condition="$i gt 5">data-role="order" style="display:none"</if>>
                    <div class="order_bd">
                        <div class="order_glist">
                            <div class="order_item">
                                <a href="javascript:void(0)" class="order_goods" style="float:left;border-bottom:none;">
                                <div class="order_goods_img">
                                        <img src="{$order.user.header}" alt="{$order.user.name}"  />
                                 </div>
                                </a>
                                <div class="order_goods_info">
                                    <div class="order_goods_name">{$order.user.name}</div>
                                    <div class="order_goods_attr">
                                        <div class="order_goods_attr_item">{$order.addtime|date="Y-m-d H:i:s",###}
                                            <div class="order_goods_price" style="text-align: right">
                                                <span>￥{$order.total_amount}元</span>
                                                <span><if condition="$order.state eq 1"> <if condition="$hongbao.addtime + 86400 gt time()"><span style="color: #0000ff" onclick="set_pay('{$order.order_sn}')">待支付</span><else/></if><elseif condition="$order.state eq 2"/><elseif condition="$order.state eq 3"/><span style="color: #000">已过期</span><elseif condition="$order.state eq 4"/><span style="color: #000">已退款</span></if></span>
                                                <if condition="$order.is_star eq 1"><br /><i class="fa fa-star"></i> 幸运星</if>
                                               </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </volist>
                <if condition="count($order_list) gt 5">
                <div class="view_all"><i style="font-size:16px; line-height: 20px;" class="fa fa-angle-double-down"></i>查看全部参与者</div>
                <!--//end-->
                </if>
           </div>
        <div class="address_new" style="margin-top: 20px; margin-bottom: 12px;"><a class='state_btn_4' href="{:U('/hongbao')}"><button class="submit"  style="width: 120px; float: left; margin-left: 30px; ">我要凑红包</button></a> <a class='state_btn_4' href="{:U('/notes')}"><button class="submit"  style="width: 120px; float: left; margin-left: 20px;">我的记录</button></a> </div>

    </div>
    </div>
</div>
<div id="shareit1" style="display: none">
    <div id="shareit" style="display: block">
        <img src="/images/share.png" class="arrow">
    </div>
    <span style="text-align: center; position: absolute; z-index: 1000; top: 30%; left: 25%" id="follow">
        <div style="padding: 0px; margin-top: 0px; font-size: 20px; color: #fff" class="text"><p>分享出去，加快进度</p></div>
        <i class="fa fa-check-circle" style="font-size:64px; color: green"></i>
        <div style="padding-right: 0px; padding-left: 0px; margin-top: 16px; font-size: 20px; color: #fff" class="text"><p>支付成功</p></div>
    </span>
</div>
<include file="Public:foot" />
 <script type="text/javascript">
     $('.view_all').click(function(){
         $('[data-role="order"]').toggle();
     });
 </script>

<script type="text/javascript">

    //立即分享到微信朋友圈点击事件
    $("#share_btn").on("click", function() {
        $("#shareit1").show();
    });


    $("#shareit1").on("click", function(){
        $("#shareit1").hide();
    })

    function show_remark(){
        layer.open({
            title: '凑红包玩法?'
            ,content: (" <span style='text-align: left'> 1. 发起凑红包 <br />"+
                    "2. 邀请朋友参与 <br/>"+
                    "3. 红包凑满后，款项会立即转给发起人（扣除2%微信支付手续费）<br/>"+
                    "4. 系统会根据参与份数，随机抽出幸运星</span>")
            ,btn: ['知道了']
        });
    }


    /**
     * 打开选择
     */
    function set_buy(){
        $('.detail_block').hide();
        $('[data-role="detail_buy"]').show();
    }

    /**
     * 生成支付订单
     */
    function set_order(){
        var id = $('input[name="id"]').val();
        var num = $('input[name="num"]').val();

        $.ajax({
            type:'post',
            url:"{:U('/hongbao/order')}",
            async:false,
            cache:false,
            data:{id:id, num:num},
            dataType:'json',
            success:function(result){
                if(result.error==0){
                    // callpay(result.data);
                    set_pay(result.data);
                }else if(result.error==1){
                    layer.msg(result.message, function(){});
                    return false;
                }
            }
        });

    }

    function set_pay(id){
        if(!id){
            var id = $('input[name="pay_id"]').val();
        }

        if(id.length < 1){
            layer.msg('没有支付订单', function(){});
            return false;
        }
        $.ajax({
            type:'post',
            url:"{:U('/weixin/pay1')}",
            async:false,
            cache:false,
            data:{id:id},
            dataType:'json',
            success:function(result){
                if(result.error==0){
                    callpay(result.data);

                }else if(result.error==1){
                    layer.msg(result.message, function(){});
                }
            }
        });
    }

    $('input.jian').click(function(){
        var num = parseInt($('input[name="num"]').val());
        var part_amount = parseInt($('input[name="part_amount"]').val());
        if(num > 1){
            $('input[name="num"]').val( num-1 );
            $('.cou_num').text( '凑 '+(num-1)+' 份');
            $('span.part_amount').text( (num-1) * part_amount);
            $('input.jia').attr('disabled', false);
        }else{
            $('input.jian').attr('disabled', true);
        }
    });

    $('input.jia').click(function(){
        var num = parseInt($('input[name="num"]').val());
        var total = parseInt($('input[name="max_total"]').val());
        var part_amount = parseInt($('input[name="part_amount"]').val());
        if(num < total){
            $('input[name="num"]').val( num+1 );
            $('.cou_num').text( '凑 '+(num+1)+' 份');
            $('span.part_amount').text( (num+1) * part_amount);
            $('input.jian').attr('disabled', false);
        }else{
            $('input.jia').attr('disabled', true);
        }
    });
    function checkHongBao(_this){
        return true;
    }

    var num = parseInt($('input[name="num"]').val());
    var part_amount = parseInt($('input[name="part_amount"]').val());

    $('.cou_num').text( '凑 '+num+' 份');
    $('span.part_amount').text( (num) * part_amount);
</script>
</body>
</html>
